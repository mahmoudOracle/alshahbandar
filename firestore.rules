rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function isSignedIn() {
      return request.auth != null;
    }

    function isPlatformAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/platformAdmins/$(request.auth.uid));
    }

    function companyUserDoc(companyId) {
      return get(/databases/$(database)/documents/companies/$(companyId)/users/$(request.auth.uid));
    }

    function isCompanyUser(companyId) {
      return isSignedIn() && companyUserDoc(companyId).exists();
    }

    function hasCompanyRole(companyId, roles) {
      return isCompanyUser(companyId) && (companyUserDoc(companyId).data.role in roles);
    }

    // Platform admin records:
    // - Allow a signed-in user to read their OWN admin record so the client
    //   can detect whether the signed-in user is a platform admin without
    //   relying on Cloud Functions (avoids requiring Blaze for simple checks).
    // - Writing admin records remains restricted to platform admins.
    match /platformAdmins/{adminId} {
      allow read: if request.auth != null && request.auth.uid == adminId;
      allow write: if isPlatformAdmin();
    }

    // Companies
    match /companies/{companyId} {
      // Allow platform admins to fully manage companies
      allow create, update, delete: if isPlatformAdmin();

      // Allow authenticated users to create their own company record during registration
      // but only if the incoming document sets status to 'pending' and the email matches auth email
      allow create: if isSignedIn() && (
        // platform admins can create as above
        isPlatformAdmin() || (
          request.resource.data.status == 'pending' &&
          request.resource.data.emailLower == request.auth.token.email.toLowerCase() &&
          request.resource.data.ownerName is string
        )
      );

      // Read allowed for authenticated members or platform admins
      allow read: if isSignedIn() && (isPlatformAdmin() || isCompanyUser(companyId));

      // Company scoped subcollections
      match /{document=**} {
        // Reads allowed for members or platform admins
        allow read: if isSignedIn() && (isPlatformAdmin() || isCompanyUser(companyId));

          // Writes allowed only for platform admins or members with sufficient role
          // For destructive operations (deletes) require server-side callable to set `isDeleted` flag.
          allow create, update: if isSignedIn() && (
            isPlatformAdmin() || hasCompanyRole(companyId, ['owner', 'manager', 'editor'])
          );

          // Prevent client-side hard deletes; require server-side callable to mark `isDeleted`.
          allow delete: if false;
      }
    }

    // Membership docs
    match /companies/{companyId}/users/{userId} {
      allow read: if isSignedIn() && (isPlatformAdmin() || isCompanyUser(companyId));
      allow create: if isSignedIn() && (
        request.auth.uid == userId || isPlatformAdmin() || hasCompanyRole(companyId, ['owner', 'manager'])
      );
      allow update, delete: if isSignedIn() && (
        request.auth.uid == userId || isPlatformAdmin() || hasCompanyRole(companyId, ['owner', 'manager'])
      );
    }

    // Invitations: NOT readable/writable by regular clients. Only server-side (Cloud Functions with admin SDK)
    // should access invitation documents. Deny client-side access to invitations to force use of callables.
    match /companies/{companyId}/invitations/{inviteId} {
      allow read, write: if false;
    }

    match /invitations/{inviteId} {
      allow read, write: if false;
    }

    // User profiles
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isPlatformAdmin());
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && (request.auth.uid == userId || isPlatformAdmin());
      allow delete: if isPlatformAdmin();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}